{{! views/products.handlebars }}
{{> header }}

<h1>Productos</h1>

<ul>
  {{#each products}}
    <li>
      <strong>{{this.title}}</strong> — ${{this.price}} | {{this.category}}
      <!-- botón para agregar al carrito (usa fetch) -->
      <button class="add-btn" data-id="{{this._id}}">Agregar al carrito</button>
      <a href="/products/{{this._id}}">Ver detalle</a>
    </li>
  {{/each}}
</ul>

<div>
  {{#if hasPrevPage}}<a href="{{prevLink}}">⬅️ Anterior</a>{{/if}}
  <span>Página {{page}} / {{totalPages}}</span>
  {{#if hasNextPage}}<a href="{{nextLink}}">Siguiente ➡️</a>{{/if}}
</div>

<script>
  // script simple para agregar (necesitás un cid - puedes crear uno previo)
  // Asumimos que tenés un carrito activo guardado en localStorage o lo pedís al backend.
  (function(){
    const CART_ID = localStorage.getItem('cartId') || null;
    document.querySelectorAll('.add-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        if (!CART_ID) {
          // crear carrito si no existe
          const res = await fetch('/api/carts', { method: 'POST' });
          const data = await res.json();
          localStorage.setItem('cartId', data.payload._id || data.payload.id || data.payload);
        }
        const pid = btn.dataset.id;
        const cid = localStorage.getItem('cartId');
        const resp = await fetch(`/api/carts/${cid}/product/${pid}`, { method: 'POST' });
        if (resp.ok) alert('Producto agregado al carrito');
        else alert('Error al agregar');
      });
    });
  })();
</script>
